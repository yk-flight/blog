<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zrkizzy.data.mapper.ModuleResourceMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.zrkizzy.data.domain.core.ModuleResource">
        <id column="id" property="id" />
        <result column="module_id" property="moduleId" />
        <result column="resource_id" property="resourceId" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, module_id, resource_id, create_time
    </sql>

    <resultMap id="ResourceVO" type="com.zrkizzy.data.vo.resource.ResourceVO">
        <id column="id" property="id" />
        <result column="name" property="name" />
        <result column="method" property="method" />
        <result column="url" property="url" />
        <result column="description" property="description" />
        <result column="create_time" property="createTime" />
    </resultMap>

    <!-- 分页查询指定模块对应请求资源 -->
    <select id="pageByModuleId" resultMap="ResourceVO">
        SELECT
            mr.id AS id,
            r.`name` AS `name`,
            r.method AS method,
            r.url AS url,
            r.description AS description,
            mr.create_time AS create_time
        FROM
            tb_module_resource mr
                LEFT JOIN tb_resource r ON mr.resource_id = r.id
        WHERE
            mr.module_id = #{moduleResourceQuery.moduleId}
        <if test="null != moduleResourceQuery.dataRange and 2 == moduleResourceQuery.dataRange.size">
            AND mr.create_time BETWEEN #{moduleResourceQuery.dataRange[0]} AND #{moduleResourceQuery.dataRange[1]}
        </if>
    </select>

    <resultMap id="ResourceLeafVO" type="com.zrkizzy.data.vo.resource.ResourceLeafVO">
        <id column="id" property="id" />
        <result column="label" property="label" />
        <result column="url" property="url" />
    </resultMap>

    <!-- 获取当前模块中所有可以添加的资源集合 -->
    <select id="findMissingResourceByModuleId" resultMap="ResourceLeafVO">
        SELECT
            r.id AS id,
            r.`name` AS label,
            r.url AS url
        FROM
            tb_resource r
    </select>

    <!-- 通过模块ID获取当前模块已有的请求资源 -->
    <select id="listCheckById" resultType="java.lang.Long">
        SELECT
            resource_id
        FROM
            tb_module_resource
        WHERE
            module_id = #{moduleId}
    </select>

    <!-- 删除指定模块对应数据 -->
    <delete id="deleteByModuleId">
        DELETE FROM tb_module_resource WHERE module_id = #{moduleId}
    </delete>

    <!-- 批量插入模块资源数据 -->
    <insert id="insertBatch">
        INSERT INTO
            tb_module_resource(<include refid="Base_Column_List"></include>)
        VALUES
        <foreach collection ="moduleResourceList" item="moduleResource" separator =",">
            (#{moduleResource.id}, #{moduleResource.moduleId}, #{moduleResource.resourceId}, #{moduleResource.createTime})
        </foreach>
    </insert>

    <!-- 根据模块ID集合批量删除 -->
    <delete id="deleteByModuleIds">
        DELETE FROM
                tb_module_resource
            <where>
            module_id IN
               <foreach collection="moduleIds" item="id" separator="," open="(" close=")">
                   #{id}
               </foreach>
            </where>
    </delete>

</mapper>
